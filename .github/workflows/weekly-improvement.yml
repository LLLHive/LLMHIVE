name: Weekly Improvement Cycle

on:
  schedule:
    # Run every Sunday at 3am UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes applied)'
        required: false
        default: 'false'
        type: boolean
      skip_benchmarks:
        description: 'Skip benchmark runs'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  weekly-improvement:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          cd llmhive
          pip install -e ".[dev]"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Node dependencies
        run: npm ci
      
      # Authenticate to GCP for Secret Manager access
      - name: Authenticate to Google Cloud
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        continue-on-error: true
      
      - name: Fetch secrets from GCP Secret Manager
        id: fetch-secrets
        if: steps.gcp-auth.outcome == 'success'
        run: |
          echo "Fetching secrets from GCP Secret Manager..."
          
          # OpenRouter API key (required for model sync)
          OPENROUTER_KEY=$(gcloud secrets versions access latest --secret="open-router-key" --project=llmhive-orchestrator 2>/dev/null || echo "")
          if [ -n "$OPENROUTER_KEY" ]; then
            echo "✅ Retrieved open-router-key from Secret Manager"
            echo "OPENROUTER_API_KEY=$OPENROUTER_KEY" >> $GITHUB_ENV
          else
            echo "::warning::Could not fetch open-router-key"
          fi
          
          # Note: Firestore access uses the WIF service account credentials (ADC)
          # No DATABASE_URL needed - the service account has Firestore access
      
      - name: Run OpenRouter Sync
        run: |
          cd llmhive
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::warning::OPENROUTER_API_KEY not available, skipping sync"
            exit 0
          fi
          python -m llmhive.app.openrouter.scheduler --sync ${{ inputs.dry_run == 'true' && '--dry-run' || '' }}
      
      - name: Run Weekly Improvement Cycle
        run: |
          cd llmhive
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::warning::OPENROUTER_API_KEY not available, running in limited mode"
          fi
          python -m llmhive.app.weekly_improvement --run \
            ${{ inputs.dry_run == 'true' && '--dry-run' || '' }} \
            ${{ inputs.skip_benchmarks == 'true' && '--no-benchmarks' || '' }} \
            --verbose
      
      - name: Run E2E Tests
        run: |
          npm run test:e2e -- --grep "Clarifying questions|Category Parity" || true
      
      - name: Upload Weekly Report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_id }}
          path: |
            llmhive/src/llmhive/app/weekly/reports/*.md
            llmhive/src/llmhive/app/weekly/reports/*.json
            llmhive/src/llmhive/app/weekly/plans/*.json
          retention-days: 90
      
      - name: Check Safety Status
        id: safety
        run: |
          # Find latest report
          REPORT=$(ls -t llmhive/src/llmhive/app/weekly/reports/*.json 2>/dev/null | head -1)
          if [ -f "$REPORT" ]; then
            SAFE=$(jq -r '.safety.safe_to_deploy' "$REPORT")
            echo "safe_to_deploy=$SAFE" >> $GITHUB_OUTPUT
            echo "report_path=$REPORT" >> $GITHUB_OUTPUT
            
            if [ "$SAFE" = "false" ]; then
              echo "::warning::Weekly improvement cycle completed with SAFE=false"
            else
              echo "Weekly improvement cycle completed successfully with SAFE=true"
            fi
          else
            echo "safe_to_deploy=unknown" >> $GITHUB_OUTPUT
            echo "::warning::No weekly report found"
          fi
      
      - name: Commit Weekly Reports
        if: inputs.dry_run != 'true' && steps.safety.outputs.safe_to_deploy == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add llmhive/src/llmhive/app/weekly/ research/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "chore: Weekly improvement report $DATE

            - Auto-generated by weekly improvement cycle
            - SAFE=${{ steps.safety.outputs.safe_to_deploy }}"
            git push
          fi
      
      - name: Create Issue on Failure
        if: failure() || steps.safety.outputs.safe_to_deploy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const safeStatus = '${{ steps.safety.outputs.safe_to_deploy }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Improvement Cycle - Action Required (${date})`,
              body: `## Weekly Improvement Cycle Report
              
              **Date:** ${date}
              **Status:** ${safeStatus === 'false' ? '❌ SAFE=false' : '⚠️ Action Required'}
              
              The weekly improvement cycle has completed but requires attention.
              
              ### Next Steps
              1. Review the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              2. Download and review the weekly report artifact
              3. Address any regressions or issues noted in the report
              4. Manually approve any gated upgrades if appropriate
              
              ### Artifacts
              - Weekly report available in workflow artifacts
              
              ---
              *This issue was auto-generated by the Weekly Improvement workflow.*`,
              labels: ['weekly-improvement', 'automated']
            });

  # Separate job for UI regression tests
  ui-regression-tests:
    runs-on: ubuntu-latest
    needs: weekly-improvement
    if: always() && needs.weekly-improvement.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Run UI Audit
        run: npm run ui:audit || true
      
      - name: Upload UI Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: ui-audit-report-${{ github.run_id }}
          path: docs/ui_audit/reports/
          retention-days: 30


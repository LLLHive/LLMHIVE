name: ModelDB Refresh

on:
  schedule:
    # Run daily at 02:15 UTC
    - cron: '15 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (validate without writing)'
        required: false
        default: 'false'
        type: boolean
      skip_update:
        description: 'Skip OpenRouter update (only run import)'
        required: false
        default: 'false'
        type: boolean
      skip_pipeline:
        description: 'Skip Firestore/Pinecone (only update Excel)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  modeldb-refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'data/modeldb/requirements.txt'
      
      - name: Install dependencies
        run: |
          pip install -r data/modeldb/requirements.txt
      
      - name: Set up Google Cloud credentials
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        continue-on-error: true
      
      - name: Run ModelDB Refresh
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GOOGLE_CLOUD_PROJECT: llmhive-orchestrator
          MODELDB_EMBEDDINGS_ENABLED: ${{ steps.gcp-auth.outcome == 'success' && 'true' || 'false' }}
        run: |
          cd data/modeldb
          
          # Build command args
          ARGS=""
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ inputs.skip_update }}" == "true" ]; then
            ARGS="$ARGS --skip-update"
          fi
          if [ "${{ inputs.skip_pipeline }}" == "true" ]; then
            ARGS="$ARGS --skip-pipeline"
          fi
          
          # If GCP auth failed, skip pipeline (Firestore/Pinecone)
          if [ "${{ steps.gcp-auth.outcome }}" != "success" ]; then
            echo "::warning::GCP auth not available, skipping Firestore/Pinecone pipeline"
            ARGS="$ARGS --skip-pipeline"
          fi
          
          python run_modeldb_refresh.py $ARGS --verbose
      
      - name: Upload run logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: modeldb-runlogs-${{ github.run_id }}
          path: |
            data/modeldb/archives/refresh_runlog_*.json
            data/modeldb/archives/modeldb_runlog_*.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Commit updated Excel
        if: inputs.dry_run != 'true' && github.event_name == 'schedule'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add Excel file if modified
          git add data/modeldb/*.xlsx || true
          git add data/modeldb/archives/*.json || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "chore(modeldb): Daily refresh $DATE

            - Updated model catalog from OpenRouter
            - Auto-generated by ModelDB Refresh workflow"
            git push
          fi
      
      - name: Report status
        if: always()
        run: |
          if [ -f "data/modeldb/archives/refresh_runlog_"*.json ]; then
            # Get latest run log
            LATEST=$(ls -t data/modeldb/archives/refresh_runlog_*.json 2>/dev/null | head -1)
            if [ -f "$LATEST" ]; then
              echo "### ModelDB Refresh Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              SUCCESS=$(jq -r '.success' "$LATEST")
              if [ "$SUCCESS" == "true" ]; then
                echo "✅ **Status:** Success" >> $GITHUB_STEP_SUMMARY
              else
                echo "❌ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Run Details:**" >> $GITHUB_STEP_SUMMARY
              echo "- Started: $(jq -r '.started_at' "$LATEST")" >> $GITHUB_STEP_SUMMARY
              echo "- Completed: $(jq -r '.completed_at' "$LATEST")" >> $GITHUB_STEP_SUMMARY
              echo "- Excel: $(jq -r '.excel_path' "$LATEST")" >> $GITHUB_STEP_SUMMARY
              echo "- Dry Run: $(jq -r '.dry_run' "$LATEST")" >> $GITHUB_STEP_SUMMARY
              
              # Show step statuses
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Steps:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.steps[] | "- \(.step): \(.status)"' "$LATEST" >> $GITHUB_STEP_SUMMARY
              
              # Show errors if any
              ERRORS=$(jq -r '.errors | length' "$LATEST")
              if [ "$ERRORS" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Errors:**" >> $GITHUB_STEP_SUMMARY
                jq -r '.errors[]' "$LATEST" | while read err; do
                  echo "- $err" >> $GITHUB_STEP_SUMMARY
                done
              fi
            fi
          fi


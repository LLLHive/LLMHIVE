name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"
  SERVICE_NAME: "llmhive-orchestrator"
  REGION: "us-east1"
  IMAGE_NAME: "llmhive-orchestrator"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        working-directory: ./llmhive
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Run tests
        working-directory: ./llmhive
        run: |
          # Run tests with reduced memory footprint
          # Exclude heavy/flaky tests and run with minimal output
          pytest tests/ --tb=short --maxfail=5 \
            --ignore=tests/test_local_model.py \
            --ignore=tests/test_mcp2_security_edge_cases.py \
            --ignore=tests/performance/ \
            --ignore=tests/benchmarks/ \
            --ignore=tests/test_live_data.py \
            --ignore=tests/integration/ \
            --ignore=tests/test_mcp2_system.py \
            --ignore=tests/systems/ \
            --ignore=tests/orchestrator/ \
            --ignore=tests/security/ \
            --ignore=tests/test_refinement_loop.py \
            --ignore=tests/test_shared_memory.py \
            --ignore=tests/test_system_metrics.py \
            --ignore=tests/test_tool_broker.py \
            -q  # Quiet mode - less memory for output
        env:
          # Set minimal test environment variables
          DATABASE_URL: "sqlite:///./test.db"
          ENVIRONMENT: "test"
          PYTHONOPTIMIZE: "2"  # Reduce memory usage
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            llmhive/.pytest_cache/
            llmhive/test-results.xml
          if-no-files-found: ignore

  build-and-deploy:
    name: Build and Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # Alternative: Use Workload Identity Federation (recommended for production)
          # workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          # service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker --quiet
      
      - name: Build Docker image
        run: |
          IMAGE="gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Building $IMAGE ..."
          docker build -t "$IMAGE" .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
      
      - name: Push Docker image
        run: |
          echo "Pushing $IMAGE to GCR ..."
          docker push "$IMAGE"
      
      - name: Deploy to Cloud Run
        run: |
          echo "Deploying $IMAGE to Cloud Run service ${{ env.SERVICE_NAME }} in region ${{ env.REGION }} ..."
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image "$IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=4Gi \
            --cpu=2 \
            --min-instances=3 \
            --max-instances=50 \
            --timeout=900 \
            --concurrency=100 \
            --update-env-vars="ALLOW_STUB_PROVIDER=true,LOG_LEVEL=INFO,OTEL_USE_GCP_TRACE=true,GCP_PROJECT_ID=llmhive-orchestrator,ENVIRONMENT=production,EMAIL_FROM=LLMHive <noreply@contact.llmhive.ai>,BUILD_COMMIT=${{ github.sha }},BUILD_TIME=$BUILD_TIME" \
            --update-secrets="OPENAI_API_KEY=openai-api-key:latest,ANTHROPIC_API_KEY=anthropic-api-key:latest,GROK_API_KEY=grok-api-key:latest,GEMINI_API_KEY=gemini-api-key:latest,DEEPSEEK_API_KEY=deepseek-api-key:latest,TAVILY_API_KEY=tavily-api-key:latest,PINECONE_API_KEY=pinecone-api-key:latest,OPENROUTER_API_KEY=open-router-key:latest,API_KEY=api-key:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,CLERK_SECRET_KEY=clerk-secret-key:latest,STRIPE_PRICE_ID_BASIC_ANNUAL=stripe-price-id-basic-annual:latest,STRIPE_PRICE_ID_BASIC_MONTHLY=stripe-price-id-basic-monthly:latest,STRIPE_PRICE_ID_ENTERPRISE_ANNUAL=stripe-price-id-enterprise-annual:latest,STRIPE_PRICE_ID_ENTERPRISE_MONTHLY=stripe-price-id-enterprise-monthly:latest,STRIPE_PRICE_ID_PRO_ANNUAL=stripe-price-id-pro-annual:latest,STRIPE_PRICE_ID_PRO_MONTHLY=stripe-price-id-pro-monthly:latest,STRIPE_PRICE_ID_MAXIMUM_MONTHLY=stripe-price-id-maximum-monthly:latest,STRIPE_PRICE_ID_MAXIMUM_ANNUAL=stripe-price-id-maximum-annual:latest,STRIPE_PUBLISHABLE_KEY=stripe-publishable-key:latest,PINECONE_HOST_ORCHESTRATOR_KB=pinecone-host-orchestrator-kb:latest,PINECONE_HOST_MODEL_KNOWLEDGE=pinecone-host-model-knowledge:latest,PINECONE_HOST_MEMORY=pinecone-host-memory:latest,PINECONE_HOST_RLHF_FEEDBACK=pinecone-host-rlhf-feedback:latest,PINECONE_HOST_AGENTIC_QUICKSTART_TEST=pinecone-host-agentic-quickstart-test:latest,SLACK_WEBHOOK_URL=slack-webhook-url:latest,RESEND_API_KEY=resend-api-key:latest" \
            --quiet
      
      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          SERVICE_URL=$(gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ env.REGION }}" \
            --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          
          # Wait a few seconds for service to be ready
          sleep 10
          
          # Health check
          curl -f "$SERVICE_URL/healthz" || echo "Health check failed (service may still be starting)"
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: $IMAGE" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed successfully! âœ…" >> $GITHUB_STEP_SUMMARY



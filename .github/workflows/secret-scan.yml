name: Secret Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run secret scanner
        run: |
          python scripts/check_no_service_account_keys.py --verbose
      
      - name: Check for service account files in tracked files
        run: |
          echo "Checking for service account files in git..."
          
          # Check for common secret file patterns
          FOUND_SECRETS=""
          
          # Check for service account JSON files
          if git ls-files | grep -E "(service.?account|sa-key|gcp.*\.json|modeldb-writer)\.json$"; then
            FOUND_SECRETS="$FOUND_SECRETS\n- Service account JSON files found"
          fi
          
          # Check for .env files (should be gitignored)
          if git ls-files | grep -E "^\.env$|/\.env$" | grep -v "\.example$"; then
            FOUND_SECRETS="$FOUND_SECRETS\n- .env files are tracked (should be gitignored)"
          fi
          
          # Check for private key files
          if git ls-files | grep -E "\.(pem|key|p12|pfx)$"; then
            FOUND_SECRETS="$FOUND_SECRETS\n- Private key files found"
          fi
          
          if [ -n "$FOUND_SECRETS" ]; then
            echo "❌ SECRETS DETECTED!"
            echo -e "$FOUND_SECRETS"
            echo ""
            echo "These files should NOT be committed to git."
            echo "Add them to .gitignore and remove from tracking:"
            echo "  git rm --cached <file>"
            exit 1
          fi
          
          echo "✅ No obvious secret files found in tracked files"
      
      - name: Verify secrets directory is not tracked
        run: |
          if git ls-files data/modeldb/secrets/ 2>/dev/null | grep -q .; then
            echo "❌ data/modeldb/secrets/ contains tracked files!"
            git ls-files data/modeldb/secrets/
            exit 1
          fi
          echo "✅ data/modeldb/secrets/ is properly gitignored"


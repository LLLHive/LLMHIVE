# cloudbuild.yaml â€” build, push, deploy to Cloud Run with correct Secret Manager mapping
# NOTE: Shell variables inside steps MUST be escaped with $$ to avoid Cloud Build substitution conflicts

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: us-east1
  _SERVICE_NAME: llmhive-orchestrator

timeout: "2400s"  # 40 minutes for large Docker images

steps:
  # 1) Build the Docker image
  - id: "Build image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        # Shell variables must be escaped with $$ in Cloud Build
        TAGVAL="${COMMIT_SHA:-$BUILD_ID}"
        IMAGEREF="gcr.io/${PROJECT_ID}/llmhive-orchestrator:$$TAGVAL"
        echo "Building $$IMAGEREF with --no-cache ..."
        docker build --no-cache -t "$$IMAGEREF" .

  # 2) Push the image
  - id: "Push image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        TAGVAL="${COMMIT_SHA:-$BUILD_ID}"
        IMAGEREF="gcr.io/${PROJECT_ID}/llmhive-orchestrator:$$TAGVAL"
        echo "Pushing $$IMAGEREF ..."
        docker push "$$IMAGEREF"

  # 3) Deploy to Cloud Run with ALL required secrets
  - id: "Deploy to Cloud Run"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        TAGVAL="${COMMIT_SHA:-$BUILD_ID}"
        IMAGEREF="gcr.io/${PROJECT_ID}/llmhive-orchestrator:$$TAGVAL"
        echo "Deploying $$IMAGEREF to Cloud Run..."
        
        gcloud run deploy "${_SERVICE_NAME}" \
          --image "$$IMAGEREF" \
          --region "${_REGION}" \
          --platform managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=2Gi \
          --cpu=2 \
          --min-instances=0 \
          --max-instances=10 \
          --timeout=900 \
          --update-env-vars="ALLOW_STUB_PROVIDER=true,LOG_LEVEL=INFO" \
          --update-secrets="\
OPENAI_API_KEY=openai-api-key:latest,\
ANTHROPIC_API_KEY=anthropic-api-key:latest,\
GROK_API_KEY=grok-api-key:latest,\
GEMINI_API_KEY=gemini-api-key:latest,\
DEEPSEEK_API_KEY=deepseek-api-key:latest,\
TAVILY_API_KEY=tavily-api-key:latest,\
PINECONE_API_KEY=pinecone-api-key:latest,\
OPENROUTER_API_KEY=open-router-key:latest,\
API_KEY=api-key:latest,\
STRIPE_SECRET_KEY=stripe-secret-key:latest,\
STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,\
CLERK_SECRET_KEY=clerk-secret-key:latest,\
STRIPE_PRICE_ID_BASIC_ANNUAL=stripe-price-id-basic-annual:latest,\
STRIPE_PRICE_ID_BASIC_MONTHLY=stripe-price-id-basic-monthly:latest,\
STRIPE_PRICE_ID_ENTERPRISE_ANNUAL=stripe-price-id-enterprise-annual:latest,\
STRIPE_PRICE_ID_ENTERPRISE_MONTHLY=stripe-price-id--enterprise-monthly:latest,\
STRIPE_PRICE_ID_PRO_ANNUAL=stripe-price-id-pro-annual:latest,\
STRIPE_PRICE_ID_PRO_MONTHLY=stripe-price-id-pro-monthly:latest,\
STRIPE_PUBLISHABLE_KEY=stripe-publishable-key:latest,\
PINECONE_HOST_ORCHESTRATOR_KB=pinecone-host-orchestrator-kb:latest,\
PINECONE_HOST_MODEL_KNOWLEDGE=pinecone-host-model-knowledge:latest,\
PINECONE_HOST_MEMORY=pinecone-host-memory:latest,\
PINECONE_HOST_RLHF_FEEDBACK=pinecone-host-rlhf-feedback:latest,\
PINECONE_HOST_AGENTIC_QUICKSTART_TEST=pinecone-host-agentic-quickstart-test:latest"
        echo "Deploy complete."

  # 4) Verify deployment and health check
  - id: "Verify deployment"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        echo "=== Cloud Run Configuration ==="
        gcloud run services describe "${_SERVICE_NAME}" --region "${_REGION}" \
          --format='table(spec.template.spec.containers[0].env[].name:label=ENV,spec.template.spec.containers[0].env[].valueFrom.secretKeyRef.name:label=SECRET_ID)'
        
        echo ""
        echo "=== Service URL ==="
        SVCURL=$$(gcloud run services describe "${_SERVICE_NAME}" --region "${_REGION}" --format='value(status.url)')
        echo "Service URL: $$SVCURL"
        
        echo ""
        echo "=== Health Check ==="
        sleep 10
        curl -s -o /dev/null -w "Health check response: %{http_code}\n" "$$SVCURL/health" || echo "Health check pending"
